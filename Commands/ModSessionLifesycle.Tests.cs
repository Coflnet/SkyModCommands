using System;
using System.Collections.Generic;
using System.Threading.Tasks;
using Coflnet.Sky.Commands;
using Coflnet.Sky.Commands.MC;
using Coflnet.Sky.Commands.Shared;
using Moq;
using NUnit.Framework;
using static Coflnet.Sky.Core.LowPricedAuction;
using Coflnet.Sky.Core;
using System.Diagnostics;
using FluentAssertions;
using Microsoft.Extensions.Logging.Abstractions;
using Coflnet.Sky.Filter;
using Coflnet.Sky.ModCommands.Services;
using Newtonsoft.Json;
using System.Linq;

namespace Coflnet.Sky.ModCommands.Tests;

public class ModSessionLifesycleTests
{
    private ModSessionLifesycle lifesycle;

    private TestSocket socket;

    [SetUp]
    public void Setup()
    {
        DiHandler.ResetProvider();
        var flipTrackingMock = new Mock<IFlipTrackingService>();
        var mockNbt = new Mock<INBT>();
        var mockIsSold = new Mock<IIsSold>();
        var stateService = new FilterStateService(null, null, null);
        mockIsSold.Setup(s => s.IsSold(It.IsAny<string>())).Returns(false);
        var exemptList = new DelayExemptionList();
        exemptList.Exemptions.Add(("TANK_WITHER_BOOTS", "matchingKey"));
        DiHandler.OverrideService<IIsSold, IIsSold>(mockIsSold.Object);
        DiHandler.OverrideService<IDelayExemptList, IDelayExemptList>(exemptList);
        DiHandler.OverrideService<IFlipTrackingService, IFlipTrackingService>(flipTrackingMock.Object);
        DiHandler.OverrideService<FilterEngine, FilterEngine>(new FilterEngine(mockNbt.Object));
        DiHandler.OverrideService<FlipperService, FlipperService>(new FlipperService(null, NullLogger<FlipperService>.Instance));
        socket = new TestSocket();
        lifesycle = new ModSessionLifesycle(socket);
        socket.SetLifecycle(lifesycle);
        socket.SessionInfo.FlipsEnabled = true;
    }

    [Test]
    public async Task PremiumTierFilterUpgrades()
    {
        var json = """
        {"filters":null,"blacklist":[{"tag":null,"displayName":null,"filter":{"HasAttribute":"true","ForceBlacklist":"true"},"tags":["temp"],"order":0,"group":null,"disabled":false},{"tag":"PET_SUBZERO_WISP","displayName":"Subzero Wisp Pet","filter":{"ProfitPercentage":"<50","ForceBlacklist":"true"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"NECRONS_LADDER","displayName":"Necron's Ladder","filter":{"StartingBid":">71m","ForceBlacklist":"true"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"DIANAS_BOOKSHELF","displayName":"Diana's Bookshelf","filter":{"StartingBid":">71m","ForceBlacklist":"true"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Seller":"fa3aa10ba2fd461a8c5e64ab5340461c","ForceBlacklist":"true"},"tags":["bad seller"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Seller":"6ddc63a9a8064ba08931a6bb2aa6bd08","ForceBlacklist":"true"},"tags":["bad seller"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Seller":"ee65df1309924715871821fd230b79b5","ForceBlacklist":"true"},"tags":["bad seller"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Seller":"8aad88159bd748bbb6134ebd0b41bfcc","ForceBlacklist":"true"},"tags":["bad seller"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Seller":"531f8df2b2534d01a608c594ecdd576e","ForceBlacklist":"true"},"tags":["bad seller"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Seller":"6acbe01575854170aad1daa5fb9e053e","ForceBlacklist":"true"},"tags":["bad seller"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Seller":"0f490c26b1e5456989de1b409faa24c5","ForceBlacklist":"true"},"tags":["bad seller"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Seller":"2fd9ef843fe8438dafcab7117ebb3275","ForceBlacklist":"true"},"tags":["bad seller"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"StartingBid":">250m","ForceBlacklist":"true","ProfitPercentage":"<20","ItemNameContains":"skin"},"tags":["cosmetics"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"StartingBid":">250m","ForceBlacklist":"true","ProfitPercentage":"<30","Skin":"Any"},"tags":["cosmetics"],"order":0,"group":null,"disabled":false},{"tag":"EMERALD_ARTIFACT","displayName":"Emerald Artifact","filter":{"NextPerk":"Stock Exchange","ProfitPercentage":"<30","ForceBlacklist":"true"},"tags":["mayor"],"order":0,"group":null,"disabled":false},{"tag":"RELIC_OF_COINS","displayName":"Relic of Coins","filter":{"NextPerk":"Stock Exchange","ProfitPercentage":"<30","ForceBlacklist":"true"},"tags":["mayor"],"order":0,"group":null,"disabled":false},{"tag":"SCAVENGER_ARTIFACT","displayName":"Scavenger Artifact","filter":{"NextPerk":"Stock Exchange","ProfitPercentage":"<30","ForceBlacklist":"true"},"tags":["mayor"],"order":0,"group":null,"disabled":false},{"tag":"CROWN_OF_AVARICE","displayName":"Crown of Avarice","filter":{"NextPerk":"Stock Exchange","ProfitPercentage":"<30","ForceBlacklist":"true"},"tags":["mayor"],"order":0,"group":null,"disabled":false},{"tag":"EMERALD_ARTIFACT","displayName":"Emerald Artifact","filter":{"ActivePerk":"Stock Exchange","ProfitPercentage":"<30","ForceBlacklist":"true"},"tags":["mayor"],"order":0,"group":null,"disabled":false},{"tag":"RELIC_OF_COINS","displayName":"Relic of Coins","filter":{"ActivePerk":"Stock Exchange","ProfitPercentage":"<30","ForceBlacklist":"true"},"tags":["mayor"],"order":0,"group":null,"disabled":false},{"tag":"SCAVENGER_ARTIFACT","displayName":"Scavenger Artifact","filter":{"ActivePerk":"Stock Exchange","ProfitPercentage":"<30","ForceBlacklist":"true"},"tags":["mayor"],"order":0,"group":null,"disabled":false},{"tag":"CROWN_OF_AVARICE","displayName":"Crown of Avarice","filter":{"ActivePerk":"Stock Exchange","ProfitPercentage":"<30","ForceBlacklist":"true"},"tags":["mayor"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"NextPerk":"Stock Exchange","ItemNameContains":"midas","ForceBlacklist":"true","ProfitPercentage":"<30"},"tags":["mayor"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"NextMayor":"Scorpius","ItemNameContains":"midas","ForceBlacklist":"true","ProfitPercentage":"<40"},"tags":["mayor"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"ActivePerk":"Stock Exchange","ItemNameContains":"midas","ForceBlacklist":"true","ProfitPercentage":"<30"},"tags":["mayor"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"CurrentMayor":"Scorpius","ItemNameContains":"midas","ForceBlacklist":"true","ProfitPercentage":"<40"},"tags":["mayor"],"order":0,"group":null,"disabled":false},{"tag":"MINOS_RELIC","displayName":"Minos Relic","filter":{"NextPerk":"Mythological Ritual","ProfitPercentage":"<30","ForceBlacklist":"true"},"tags":["mayor"],"order":0,"group":null,"disabled":false},{"tag":"MINOS_RELIC","displayName":"Minos Relic","filter":{"ActivePerk":"Mythological Ritual","ProfitPercentage":"<30","ForceBlacklist":"true"},"tags":["mayor"],"order":0,"group":null,"disabled":false},{"tag":"PET_GRIFFIN","displayName":"Griffin Pet","filter":{"ActivePerk":"Mythological Ritual","ProfitPercentage":"<30","ForceBlacklist":"true"},"tags":["mayor"],"order":0,"group":null,"disabled":false},{"tag":"DAEDALUS_AXE","displayName":"Daedalus Blade","filter":{"ActivePerk":"Mythological Ritual","ProfitPercentage":"<30","ForceBlacklist":"true"},"tags":["mayor"],"order":0,"group":null,"disabled":false},{"tag":"STARRED_DAEDALUS_AXE","displayName":"âšš Daedalus Blade","filter":{"ActivePerk":"Mythological Ritual","ProfitPercentage":"<30","ForceBlacklist":"true"},"tags":["mayor"],"order":0,"group":null,"disabled":false},{"tag":"HURRICANE_IN_A_BOTTLE","displayName":"Hurricane in a Bottle","filter":{"ForceBlacklist":"true","ProfitPercentage":"<40"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"STORM_IN_A_BOTTLE","displayName":"Storm in a Bottle","filter":{"ForceBlacklist":"true","ProfitPercentage":"<40"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"ItemCategory":"ArmorDye","Rarity":"LEGENDARY","ProfitPercentage":"<30","ForceBlacklist":"true"},"tags":["cosmetics"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"ItemCategory":"ArmorDye","Rarity":"EPIC","ProfitPercentage":"<30","ForceBlacklist":"true"},"tags":["cosmetics"],"order":0,"group":null,"disabled":false},{"tag":"SKELETON_MASTER_CHESTPLATE","displayName":"Skeleton Master Chestplate","filter":{"BaseStatBoost":"<50","ProfitPercentage":"<100","ForceBlacklist":"true"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Skin":"Any","StartingBid":">100m","ProfitPercentage":"<100","ForceBlacklist":"true","FlipFinder":"MedianBased"},"tags":["cosmetics"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"ItemCategory":"PET_SKIN","FlipFinder":"STONKS","ProfitPercentage":"<50","ForceBlacklist":"true"},"tags":["risky"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Skin":"Any","FlipFinder":"STONKS","ProfitPercentage":"<50","ForceBlacklist":"true"},"tags":["risky"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Volatility":">50","ForceBlacklist":"true","Profit":"<50m","ProfitPercentage":"<50"},"tags":["general"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Volatility":">50","ForceBlacklist":"true","Profit":"<10m"},"tags":["general"],"order":0,"group":null,"disabled":false},{"tag":"RUNE_ENCHANT","displayName":"Enchant Rune","filter":{"ForceBlacklist":"true","ProfitPercentage":"<100"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"IntroductionAgeDays":"10","ProfitPercentage":"<30","ForceBlacklist":"true"},"tags":["new items"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"IntroductionAgeDays":"4","ProfitPercentage":"<100","ForceBlacklist":"true"},"tags":["new items"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"IntroductionAgeDays":"2","ProfitPercentage":"<200","ForceBlacklist":"true"},"tags":["new items"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Profit":"<5m","ForceBlacklist":"true","ItemCategory":"PET_SKIN"},"tags":["cosmetics"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"ListingSlotsLeft":"0-2","Profit":"<3m","ForceBlacklist":"true"},"tags":["slots"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"ListingSlotsLeft":"0","Profit":"<5m","ForceBlacklist":"true"},"tags":["slots"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"FlipFinder":"STONKS","StartingBid":">2m","Profit":"<6m","ForceBlacklist":"true"},"tags":["risky"],"order":0,"group":null,"disabled":false},{"tag":"DIAMOND_PICKAXE","displayName":"Diamond Pickaxe","filter":{"FlipFinder":"TFM","ForceBlacklist":"true"},"tags":["risky"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"ItemCategory":"PRIVATE_ISLAND","ForceBlacklist":"true"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"ItemCategory":"RUNE","ForceBlacklist":"true","FlipFinder":"MedianBased","ProfitPercentage":"<100"},"tags":["cosmetics"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Volatility":">10","ProfitPercentage":"<9","ForceBlacklist":"true"},"tags":["general"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Volatility":">10","Profit":"<2m","ForceBlacklist":"true"},"tags":["general"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Profit":"<1.5m","UtcHourOfDay":"15-20","ForceBlacklist":"true","UserPremiumTier":"PREMIUM_PLUS"},"tags":["general"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"ItemCategory":"PET","FlipFinder":"SNIPER","Profit":"<6m","PetLevel":"30-99","ForceBlacklist":"true"},"tags":["general"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Profit":"<1m","ForceBlacklist":"true"},"tags":["adjust"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Profit":"<1.5m","UserPremiumTier":"PREMIUM_PLUS","ForceBlacklist":"true"},"tags":["adjust"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Profit":"<2m","ProfitPercentage":"<10","ForceBlacklist":"true"},"tags":["general"],"order":0,"group":null,"disabled":false},{"tag":"ECCENTRIC_PAINTING_BUNDLE","displayName":"Eccentric Painting Bundle","filter":{"CurrentMayor":"Scorpius","ProfitPercentage":"<40","ForceBlacklist":"true"},"tags":["mayor"],"order":0,"group":null,"disabled":false},{"tag":"MAGIC_8_BALL","displayName":"Magic 8 Ball","filter":{"CurrentMayor":"Scorpius","ProfitPercentage":"<40","ForceBlacklist":"true"},"tags":["mayor"],"order":0,"group":null,"disabled":false},{"tag":"SIRIUS_PERSONAL_PHONE_NUMBER","displayName":"Sirius' Personal Phone Number","filter":{"CurrentMayor":"Scorpius","ProfitPercentage":"<40","ForceBlacklist":"true"},"tags":["mayor"],"order":0,"group":null,"disabled":false},{"tag":"HOCUS_POCUS_CIPHER","displayName":"Hocus-Pocus Cipher","filter":{"CurrentMayor":"Scorpius","ProfitPercentage":"<40","ForceBlacklist":"true"},"tags":["mayor"],"order":0,"group":null,"disabled":false},{"tag":"ECCENTRIC_PAINTING_BUNDLE","displayName":"Eccentric Painting Bundle","filter":{"NextMayor":"Scorpius","ProfitPercentage":"<40","ForceBlacklist":"true"},"tags":["mayor"],"order":0,"group":null,"disabled":false},{"tag":"MAGIC_8_BALL","displayName":"Magic 8 Ball","filter":{"NextMayor":"Scorpius","ProfitPercentage":"<40","ForceBlacklist":"true"},"tags":["mayor"],"order":0,"group":null,"disabled":false},{"tag":"SIRIUS_PERSONAL_PHONE_NUMBER","displayName":"Sirius' Personal Phone Number","filter":{"NextMayor":"Scorpius","ProfitPercentage":"<40","ForceBlacklist":"true"},"tags":["mayor"],"order":0,"group":null,"disabled":false},{"tag":"HOCUS_POCUS_CIPHER","displayName":"Hocus-Pocus Cipher","filter":{"NextMayor":"Scorpius","ProfitPercentage":"<40","ForceBlacklist":"true"},"tags":["mayor"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"ProfitPercentage":"<9","Volume":"<0.2","ForceBlacklist":"true"},"tags":["general"],"order":0,"group":null,"disabled":false},{"tag":"HIGH_CLASS_ARCHFIEND_DICE","displayName":"High Class Archfiend Dice","filter":{"ProfitPercentage":"<20","ForceBlacklist":"true"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"AverageTimeToSell":">24h","ProfitPercentage":"<8","Profit":"<20m","ForceBlacklist":"true"},"tags":["general"],"order":0,"group":null,"disabled":false}],"whitelist":[{"tag":null,"displayName":null,"filter":{"CraftCostWeight":"default:0.9,pgems:1.0,drill_part_upgrade_module:1.0,drill_part_fuel_tank:1.0,drill_part_engine:1.0,dye_item:0.09,growth.6:0,protection.6:0,hecatomb:0,big_brain:0.4","ForTag":"DEFAULT"},"tags":["Weight"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"MinProfitPercentage":"18","Volatility":"<10"},"tags":["fast"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"EstProfitPerHour":">1.5m","MinProfitPercentage":"10"},"tags":["pph"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"EstProfitPerHour":">1.1m","MinProfitPercentage":"8","FlipFinder":"MedianBased"},"tags":["pph"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"EstProfitPerHour":">1.5m","MinProfitPercentage":"5","Purse":">1.8b"},"tags":["pph"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"EstProfitPerHour":">900k","MinProfitPercentage":"8","UtcHourOfDay":"6-13","UtcDayOfWeek":"1-5"},"tags":["pph"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"EstProfitPerHour":">850k","MinProfit":"20000000","MinProfitPercentage":"6","FlipFinder":"MedianBased"},"tags":["pph"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"EstProfitPerHour":"450k","MinProfitPercentage":"12","UserPremiumTier":"PREMIUM"},"tags":["pph"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Volume":">35","FlipFinder":"FLIPPER_AND_SNIPERS","Volatility":"<9","MinProfit":"1500000","MinProfitPercentage":"10"},"tags":["fast"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Volume":">70","FlipFinder":"FLIPPER_AND_SNIPERS","Volatility":"<9","MinProfit":"500000","MinProfitPercentage":"10"},"tags":["fast"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"MinProfit":"30000000","MinProfitPercentage":"20"},"tags":["fast"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"MinProfit":"5000000","MinProfitPercentage":"500"},"tags":["fast"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"MinProfit":"10000000","MinProfitPercentage":"200"},"tags":["fast"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"PerfectGemsCount":"2-5","Profit":"10000000","MinProfitPercentage":"18"},"tags":["fast"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"AverageTimeToSell":"<5m","MinProfit":"500000","MinProfitPercentage":"100","Volatility":"<10"},"tags":["tts"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"AverageTimeToSell":"<24h","MinProfit":"10000000","MinProfitPercentage":"15"},"tags":["tts"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"AverageTimeToSell":"<6h","MinProfit":"3000000","MinProfitPercentage":"8","FlipFinder":"MedianBased"},"tags":["tts"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"AverageTimeToSell":"<8h","MinProfit":"5000000","MinProfitPercentage":"8","FlipFinder":"MedianBased"},"tags":["tts"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"AverageTimeToSell":"<12h","MinProfit":"5000000","MinProfitPercentage":"8","FlipFinder":"MedianBased","UtcHourOfDay":"6-13","UtcDayOfWeek":"1-5"},"tags":["tts"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"AverageTimeToSell":"<12h","MinProfit":"8000000","MinProfitPercentage":"6"},"tags":["tts"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"AverageTimeToSell":"<15h","MinProfit":"8000000","MinProfitPercentage":"6","FlipFinder":"MedianBased"},"tags":["tts"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"AverageTimeToSell":"<17h","MinProfit":"8000000","MinProfitPercentage":"6","FlipFinder":"MedianBased","UtcHourOfDay":"6-13","UtcDayOfWeek":"1-5"},"tags":["tts"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"AverageTimeToSell":"<18h","MinProfit":"13000000","MinProfitPercentage":"6"},"tags":["tts"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"AverageTimeToSell":"<21h","MinProfit":"13000000","MinProfitPercentage":"6","FlipFinder":"MedianBased"},"tags":["tts"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"AverageTimeToSell":"<24h","MinProfit":"13000000","MinProfitPercentage":"6","FlipFinder":"MedianBased","UtcHourOfDay":"6-13","UtcDayOfWeek":"1-5"},"tags":["tts"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"AverageTimeToSell":"<36h","MinProfit":"25000000","MinProfitPercentage":"6"},"tags":["tts"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"AverageTimeToSell":"<48h","MinProfit":"25000000","MinProfitPercentage":"6","FlipFinder":"MedianBased"},"tags":["tts"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"AverageTimeToSell":"<72h","MinProfit":"25000000","MinProfitPercentage":"6","FlipFinder":"MedianBased","UtcHourOfDay":"6-13","UtcDayOfWeek":"1-5"},"tags":["tts"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"AverageTimeToSell":"<96h","MinProfit":"75000000","MinProfitPercentage":"6"},"tags":["tts"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Volume":">4","MinProfit":"3000000","MinProfitPercentage":"8"},"tags":["vlm"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Volume":">3","MinProfit":"5000000","MinProfitPercentage":"8"},"tags":["vlm"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Volume":">2.5","MinProfit":"5000000","MinProfitPercentage":"8","UtcHourOfDay":"6-13","UtcDayOfWeek":"1-5"},"tags":["vlm"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Volume":">2","MinProfit":"8000000","MinProfitPercentage":"6"},"tags":["vlm"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Volume":">1.5","MinProfit":"8000000","MinProfitPercentage":"6","UtcHourOfDay":"6-13","UtcDayOfWeek":"1-5"},"tags":["vlm"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Volume":">1.3","MinProfit":"13000000","MinProfitPercentage":"6"},"tags":["vlm"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Volume":">1","MinProfit":"13000000","MinProfitPercentage":"6","UtcHourOfDay":"6-13","UtcDayOfWeek":"1-5"},"tags":["vlm"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Volume":">0.6","MinProfit":"25000000","MinProfitPercentage":"6"},"tags":["vlm"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Volume":">0.4","MinProfit":"25000000","MinProfitPercentage":"6","UtcHourOfDay":"6-13","UtcDayOfWeek":"1-5"},"tags":["vlm"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Volume":">0.3","MinProfit":"75000000","MinProfitPercentage":"6"},"tags":["vlm"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"PerfectGemsCount":"1-5","MaxCost":"6000000"},"tags":["gems"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"PerfectGemsCount":"2-5","MaxCost":"14000000"},"tags":["gems"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"PerfectGemsCount":"3-5","MaxCost":"23000000"},"tags":["gems"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"PerfectGemsCount":"4-5","MaxCost":"30000000"},"tags":["gems"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"PerfectGemsCount":"5-5","MaxCost":"40000000"},"tags":["gems"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"AhCategory":"ACCESSORIES","Recombobulated":"true","MinProfit":"3000000","MinProfitPercentage":"15"},"tags":["hmm"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"ItemCategory":"PET_SKIN","MinProfit":"40000000","MinProfitPercentage":"15"},"tags":["cosmetics"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"Skin":"Any","MinProfit":"40000000","MinProfitPercentage":"15"},"tags":["cosmetics"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"ItemCategory":"ACCESSORY","Recombobulated":"true","MaxCost":"3000000"},"tags":["hmm"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"DrillPartEngine":"Any","MinProfit":"20000000","MinProfitPercentage":"7"},"tags":["drill"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"DrillPartFuelTank":"Any","MinProfit":"20000000","MinProfitPercentage":"7"},"tags":["drill"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"DrillPartUpgradeModule":"Any","MinProfit":"10000000","MinProfitPercentage":"7"},"tags":["drill"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"DrillPartUpgradeModule":"goblin_omelette_blue_cheese","MinProfitPercentage":"50"},"tags":["drill"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"ItemCategory":"DRILL","MinProfitPercentage":"15"},"tags":["drill"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"ItemCategory":"PET","MinProfit":"3000000","MinProfitPercentage":"12","Volume":">2"},"tags":["hmm"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"ItemCategory":"ABIPHONE","MinProfit":"5000000","MinProfitPercentage":"15"},"tags":["hmm"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"ItemCategory":"ACCESSORY","MinProfitPercentage":"15"},"tags":["hmm"],"order":0,"group":null,"disabled":false},{"tag":"TITANIUM_DRILL_4","displayName":"Titanium Drill DR-X655","filter":{"DrillPartEngine":"Any","DrillPartFuelTank":"Any","DrillPartUpgradeModule":"Any","MaxCost":"290000000"},"tags":["user"],"order":0,"group":null,"disabled":false},{"tag":"JUDGEMENT_CORE","displayName":"Judgement Core","filter":{"MaxCost":"150000000"},"tags":["user"],"order":0,"group":null,"disabled":false},{"tag":"TERMINATOR","displayName":"Terminator","filter":{"MaxCost":"370000000"},"tags":["user"],"order":0,"group":null,"disabled":false},{"tag":"PET_GOLDEN_DRAGON","displayName":"Golden Dragon Pet","filter":{"MaxCost":"500000000"},"tags":["user"],"order":0,"group":null,"disabled":false},{"tag":"PET_GOLDEN_DRAGON","displayName":"Golden Dragon Pet","filter":{"MaxCost":"800000000","PetLevel":"200"},"tags":["user"],"order":0,"group":null,"disabled":false},{"tag":"PET_ENDER_DRAGON","displayName":"Ender Dragon Pet","filter":{"MaxCost":"230000000"},"tags":["user"],"order":0,"group":null,"disabled":false},{"tag":"PET_ENDER_DRAGON","displayName":"Ender Dragon Pet","filter":{"MaxCost":"500000000","Rarity":"LEGENDARY","PetItem":"NOT_TIER_BOOST"},"tags":["user"],"order":0,"group":null,"disabled":false},{"tag":"PET_SCATHA","displayName":"Scatha Pet","filter":{"MaxCost":"50000000"},"tags":["user"],"order":0,"group":null,"disabled":false},{"tag":"PET_SCATHA","displayName":"Scatha Pet","filter":{"MaxCost":"200000000","Rarity":"LEGENDARY","PetItem":"NOT_TIER_BOOST"}},{"tag":"PET_SCATHA","displayName":"Scatha Pet","filter":{"MinProfitPercentage":"10"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"HYPERION","displayName":"Hyperion","filter":{"MinProfitPercentage":"7"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"VALKYRIE","displayName":"Valkyrie","filter":{"MinProfitPercentage":"7"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"ASTRAEA","displayName":"Astraea","filter":{"MinProfitPercentage":"7"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"SCYLLA","displayName":"Scylla","filter":{"MinProfitPercentage":"7"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"NECRON_BLADE","displayName":"Necron's Blade (Unrefined)","filter":{"MinProfitPercentage":"7"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"TERMINATOR","displayName":"Terminator","filter":{"MinProfitPercentage":"6"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"PET_GOLDEN_DRAGON","displayName":"Golden Dragon Pet","filter":{"MinProfitPercentage":"5"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"GIANTS_SWORD","displayName":"Giant's Sword","filter":{"MinProfitPercentage":"6"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"DARK_CLAYMORE","displayName":"Dark Claymore","filter":{"MinProfitPercentage":"7"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"MIDAS_STAFF","displayName":"Midas Staff","filter":{"MinProfitPercentage":"15"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"STARRED_MIDAS_STAFF","displayName":"âšš Midas Staff","filter":{"MinProfitPercentage":"15"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"MIDAS_SWORD","displayName":"Midas' Sword","filter":{"MinProfitPercentage":"15"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"STARRED_MIDAS_SWORD","displayName":"âšš Midas' Sword","filter":{"MinProfitPercentage":"15"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"WARDEN_HELMET","displayName":"Warden Helmet","filter":{"MinProfitPercentage":"10"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"PET_ENDER_DRAGON","displayName":"Ender Dragon Pet","filter":{"MinProfitPercentage":"10"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"PET_JADE_DRAGON","displayName":"Jade Dragon Pet","filter":{"MinProfitPercentage":"8"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"STARRED_BONE_NECKLACE","displayName":"âšš Bone Necklace","filter":{"MinProfitPercentage":"15"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"STARRED_SHADOW_ASSASSIN_CLOAK","displayName":"âšš Shadow Assassin Cloak","filter":{"MinProfitPercentage":"15"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"STARRED_ADAPTIVE_BELT","displayName":"âšš Adaptive Belt","filter":{"MinProfitPercentage":"15"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"SOULWEAVER_GLOVES","displayName":"Soulweaver Gloves","filter":{"MinProfitPercentage":"15"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"HELLFIRE_ROD","displayName":"Hellfire Rod","filter":{"MinProfitPercentage":"15"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"ATOMSPLIT_KATANA","displayName":"Atomsplit Katana","filter":{"MinProfitPercentage":"20"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"DAEDALUS_AXE","displayName":"Daedalus Blade","filter":{"MinProfitPercentage":"15","Volume":">2"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":"STARRED_DAEDALUS_AXE","displayName":"âšš Daedalus Blade","filter":{"MinProfitPercentage":"15","Volume":">2"},"tags":["case"],"order":0,"group":null,"disabled":false},{"tag":null,"displayName":null,"filter":{"ultimate_chimera":"1-5","MinProfitPercentage":"20"},"tags":["case"],"order":0,"group":null,"disabled":false}],"lbin":false,"visibility":{"cost":true,"estProfit":true,"lbin":false,"slbin":false,"medPrice":false,"seller":false,"volume":true,"extraFields":3,"avgSellTime":false,"profitPercent":true,"profit":false,"sellerOpenBtn":false,"lore":true,"links":false,"copySuccessMessage":true,"hideSold":false,"hideManipulated":false},"mod":{"justProfit":true,"soundOnFlip":true,"shortNumbers":false,"shortNames":false,"blockTenSecMsg":false,"format":"Â§6Â§l{0}:Â§x  [menu]{1}{2} Â§c{4} {3}â‡¨ Â§a{5} Â§e(+{6} Â§6{7}%Â§e) Â§6Daily: Â§ax{10}","blockedFormat":null,"chat":false,"countdown":true,"hideNoBestFlip":false,"timerX":0,"timerY":0,"timerSeconds":0,"timerScale":0.0,"timerPrefix":null,"timerPrecision":0,"blockedMsg":0,"maxPercentOfPurse":0,"noBedDelay":false,"streamerMode":false,"autoStartFlipper":false,"normalSoldFlips":false,"tempBlacklistSpam":false,"dataOnlyMode":false,"ahListHours":0,"quickSell":false,"maxItemsInInventory":0,"disableSpamProtection":false},"finders":119,"fastMode":false,"publishedAs":null,"loadedVersion":0,"changer":"9be820db-c5f7-44f3-a9d1-2ee7ef7b7915","onlyBin":true,"whitelistAftermain":false,"basedConfig":null,"blockExport":false,"blockHighCompetition":false,"minProfit":500000,"minProfitPercent":8,"minVolume":3.0,"maxCost":10000000000,"lastChange":null}
        """;
        var settings = new FlipSettings()
        {
            BlackList = new()
            {
                new(){
                    filter= new Dictionary<string, string>
                    {
                        {"Profit", "<1.5m"},
                        {"UserPremiumTier", "PREMIUM_PLUS"},
                        {"ForceBlacklist", "true"}
                    },
                },
            },
            WhiteList = new()
            {
                new()
                {
                    filter = new Dictionary<string, string>
                    {
                        {"Profit", "<1.5m"},
                    },
                },
            },
            Visibility = new()
            {
                Volume = true,
            },
            ModSettings = new()
            {

            },
            AllowedFinders = (FinderType)119
        };
        settings = JsonConvert.DeserializeObject<FlipSettings>(json);
        ClearStateFilters(settings.BlackList);
        ClearStateFilters(settings.WhiteList);
        lifesycle.FlipSettings = await SelfUpdatingValue<FlipSettings>.CreateNoUpdate(() => settings);
        await lifesycle.ApplyFlipSettings(settings, null);
        lifesycle.SessionInfo.SessionTier = AccountTier.PREMIUM_PLUS;
        await lifesycle.FlipProcessor.ProcessFlip(CreateSampleFlip());
        lifesycle.FlipProcessor.BlockedFlipCount.Should().Be(1);

        lifesycle.SessionInfo.SessionTier = AccountTier.NONE;
        await lifesycle.FlipProcessor.ProcessFlip(CreateSampleFlip());
        lifesycle.FlipProcessor.BlockedFlipCount.Should().Be(1);

        lifesycle.SessionInfo.SessionTier = AccountTier.STARTER_PREMIUM;
        await lifesycle.FlipProcessor.ProcessFlip(CreateSampleFlip());
        lifesycle.FlipProcessor.BlockedFlipCount.Should().Be(2);

        socket.Flips.Count.Should().Be(1); // 1 flip sent
        lifesycle.SessionInfo.SessionTier = AccountTier.PREMIUM_PLUS;
        await lifesycle.FlipProcessor.ProcessFlip(CreateSampleFlip());
        socket.Flips.Count.Should().Be(1); // 1 flip sent

        static void ClearStateFilters(List<ListEntry> list)
        {
            foreach (var item in list.ToList())
            {
                if (item.filter.Any(f => f.Key.Contains("Category") || f.Key.Contains("Mayor") || f.Key.Contains("IntroductionAgeDays") || f.Key.Contains("Perk")))
                    list.Remove(item);
            }
        }
    }

    private static LowPricedAuction CreateSampleFlip()
    {
        return new LowPricedAuction
        {
            Auction = new()
            {
                Uuid = Guid.NewGuid().ToString("N"),
                Tag = "TANK_WITHER_BOOTS",
                StartingBid = 5300000,
                Bin = true,
            },
            Finder = FinderType.SNIPER_MEDIAN,
            AdditionalProps = new()
            {
                {"key","matchingKey"}
            },
            TargetPrice = 6_500_000
        };
    }

    public class TestSocket : MinecraftSocket
    {
        public List<ChatPart[]> Messages = new();
        public List<FlipInstance> Flips = new();
        public override bool IsClosed => false;
        public override Activity CreateActivity(string name, Activity parent = null)
        {
            return null; // don't trace in test
        }
        public override bool SendMessage(params ChatPart[] parts)
        {
            Messages.Add(parts);
            return true;
        }
        public void SetLifecycle(ModSessionLifesycle lifesycle)
        {
            this.sessionLifesycle = lifesycle;
            this.ModAdapter = new TestModAdapter(this);
        }
        public TestSocket()
        {
        }
    }

    public class TestModAdapter : BinGuiVersionAdapter
    {
        public TestModAdapter(TestSocket socket) : base(socket)
        {
            this.socket = socket;
        }
        public override async Task<bool> SendFlip(FlipInstance flip)
        {
            (socket as TestSocket).Flips.Add(flip);
            return true;
        }
    }
}
